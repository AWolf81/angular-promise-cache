(function(b,a,c){'use strict';a.module("angular-promise-cache",[]).factory("promiseCache",["$q","$rootScope",function(p,l){var t={},r=5000,s="$",q=/\s+/g,f={},j=b.localStorage,i=function(v,w){j.setItem(v,JSON.stringify(w))},u=function(v){j.removeItem(v)},n=function(v){var x=j.getItem(v);try{x=JSON.parse(x)}catch(w){console.warn("Unable to parse json response from local storage",x)}return x},k=function(w,v){return parseInt(w.split(s)[1])||f[v]},e=function(v){return s+v+s},g=function(v){return v.key||v.promise.toString().replace(q,"")},o=function(v){return !!v.localStorageEnabled},m=function(w,v){return w.localStorageKey||v},d=typeof _!=="undefined"&&hasOwnProperty.call(_,"memoize")?_.memoize:function d(x,y){var w=+new Date+"",v=function(){var z=v.cache,A=y?y.apply(this,arguments):w+arguments[0];return hasOwnProperty.call(z,A)?z[A]:(z[A]=x.apply(this,arguments))};v.cache={};return v};var h=function(v){var J=v.promise,C=parseInt(v.ttl)||r,B=!!v.bustCache,A=v.expireOnFailure,H=v.args,z=new Date().getTime(),F=g(v),D=o(v),E=m(v,F),x=n(E),G,w,y,I;f[F]=f[F]||z;if(D){if(!x||typeof x!=="object"||!hasOwnProperty.call(x,"resolver")||!hasOwnProperty.call(x,"response")){x={}}else{G=k(x.resolver,F);y=G+C-z;t[F]=d(J,function(){return e(G)});w=t[F].cache||{};I=p.defer();I.resolve(x.response);w[e(G)]=I.promise;t[F].cache=w}}if(!hasOwnProperty.call(t,F)){t[F]=d(J,function(){return e(f[F])});t[F].opts=v;l.$broadcast("angular-promise-cache.new",e(f[F]),F)}else{t[F].opts=v;t[F].cache=(function(){var P={},L=t[F].cache,K=!!t[F].forceExpiration,M,O,N;for(M in L){O=k(M,F);N=B||K||(C>0&&O+C<z);if(N){l.$broadcast("angular-promise-cache.expired",M,F);f[F]=z;if(D){G=f[F];u(E)}}else{l.$broadcast("angular-promise-cache.active",M,O+C,F);P[M]=L[M]}}t[F].forceExpiration=false;return P}())}return t[F].apply(this,H).then(function(K){if(D){x.response=arguments[0];x.resolver=e(G||f[F]);i(E,x)}return K},function(K){if(a.isFunction(A)&&A.apply(this,arguments)){t[F].forceExpiration=true}return p.reject(K)})};h.remove=function(v,x){if(!t[v]){return}var w=t[v].opts;f[v]=new Date().getTime();if(!x&&o(w)){u(m(w,v))}delete t[v];l.$broadcast("angular-promise-cache.removed",v)};return h}])})(window,window.angular);